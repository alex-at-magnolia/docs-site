<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>JCR persistence - Magnolia 6.2 documentation :: Magnolia CMS Docs</title>
    <link rel="canonical" href="http://localhost:9096/magnolia-docs/core/modules/JCR_persistence.html">
    <meta name="generator" content="Antora 2.3.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <link rel="icon" href="../../../_/img/favicon.ico" type="image/x-icon">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="">
        <img class="logo" src="../../../_/img/magnolia-medium.png" style="width: 10rem; height:auto; margin-left:0.8rem; margin-top:0.4rem;" alt="Magnolia">
      </a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Releases</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Core</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Getting Started</a>
            <a class="navbar-item" href="#">Features</a>
            <a class="navbar-item" href="#">Developing</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Cloud</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Getting Started</a>
            <a class="navbar-item" href="#">Features</a>
            <a class="navbar-item" href="#">Cloud Light Development</a>
            <a class="navbar-item" href="#">Upgrading in the Cloud</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Headless</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Getting Started</a>
            <a class="navbar-item" href="#">Visual SPA Editor</a>
            <a class="navbar-item" href="#">API</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="https://www.magnolia-cms.com/get-started">Get Magnolia</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
  <div class="lower-head">
    
  </div>
</header>
<div class="body">
<div class="nav-container" data-component="magnolia-docs" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Releases and Upgrading</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../releases/Releases.html">Releases</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../upgrade/Upgrading-to-Magnolia-6.2.x.html">Upgrading-to-Magnolia-6.2.x</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Getting Started</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../getting-started/hello-magnolia.html">Hello Magnolia</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../cloud/getting-started/hello-cloud.html">Hello Magnolia Cloud</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Features</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../features/Cache.html">Cache</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../features/Commenting.html">Commenting</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../features/content-authoring.html">Content authoring</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../features/content-editor.html">Content editor</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../features/content-tagging.html">Content tagging</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../features/content-types.html">Content types</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../features/data-privacy.html">Data privacy</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../features/dam.html">Digital asset management</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../features/find-bar.html">Find bar</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../features/image-recognition.html">Image recognition</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="#core/features/integration.adoc">Integration</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../features/Personalization.html">Personalization</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../features/component-personalization.html">Component personalization</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../features/rest-in-magnolia.html">REST in Magnolia</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../features/Search.html">Search</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#core/features/jackrabbit-search.adoc">Placeholder</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#core/features/solr-search.adoc">Placeholder</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../features/search-engine-optimization.html">SEO</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../features/spa.html">SPA</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../features/Tasks.html">Tasks</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../features/text-classification.html">Text classification</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../features/Workflow.html">Workflow</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Cloud</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../cloud/Magnolia-Cloud.html">Cloud</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Administration</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../administration/Administration.html">Administration</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Developing</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../developing/Developing.html">Developing</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Templating</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../templating/Templating.html">Templating</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Modules</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Modules.html">Modules</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Authoring</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../authoring/Logging_in.html">Logging in</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../authoring/Editing_pages.html">Editing pages</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../authoring/Managing_pages.html">Managing pages</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../authoring/Editing_images.html">Editing images</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../authoring/Managing_assets.html">Managing assets</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../authoring/Publishing.html">Publishing</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../authoring/Deleting_and_restoring.html">Deleting and restoring</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../authoring/Versioning.html">Versioning</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../authoring/Keyboard_shortcuts.html">Keyboard shortcuts</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../authoring/Feeds.html">Feeds</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Connector Packs</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../connector-packs/Connector_Packs.html">Connector Packs Overview</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../connector-packs/Analytics_Connector_Pack.html">Analytics Connector Pack</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connector-packs/Analytics_module.html">Analytics module</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connector-packs/Integrated_User_Experience.html">Integrated User Experience</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../connector-packs/Commerce_Connector_Pack.html">Commerce Connector Pack</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connector-packs/E-commerce_app.html">E-commerce app</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connector-packs/E-commerce_module.html">E-commerce module</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connector-packs/ecomfn.html">ecomfn Templating function</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connector-packs/E-commerce_REST_endpoints.html">E-commerce REST endpoints</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connector-packs/How_to_configure_a_custom_e-commerce_connector.html">Configure a custom e-commerce connector</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../connector-packs/DAM_Connector_Pack.html">DAM Connector Pack</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connector-packs/External_DAM_module.html">External DAM module</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../connector-packs/Marketing_Automation_Connector_Pack.html">Marketing Automation Connector Pack</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connector-packs/Marketing_Automation_module.html">Marketing automation module</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connector-packs/Marketing_Automation_REST_endpoint.html">Marketing automation REST endpoint</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../connector-packs/Optimization_Connector_Pack.html">Optimization Connector Pack</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../connector-packs/Siteimprove_module.html">Siteimprove module</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Apps</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../apps/Apps.html">Apps</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">CLI</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../cli/Magnolia-CLI.html">Command Line Interface</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../cli/Magnolia-CLI-v3.html">Magnolia CLI v3</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../cli/Updating-CLI-to-v3.html">Updating CLI to v3</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../cli/Magnolia-CLI-v2.html">Magnolia CLI v2</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../cli/Magnolia-CLI-walkthrough.html">Magnolia CLI walkthrough</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Special Features</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../special-features/Special-Features.html">Special Features</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Magnolia Documentation</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component">
      <span class="title">Home</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../home/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <span class="title">Magnolia Documentation</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../../index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
    <a href="../../../home/index.html" class="home-link"></a>

<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../index.html">Magnolia Documentation</a></li>
    <li><a href="JCR_persistence.html">JCR persistence - Magnolia 6.2 documentation</a></li>
  </ul>
</nav>

</div>
  <div class="content">
<article class="doc">
<h1 class="page">JCR persistence - Magnolia 6.2 documentation</h1>
<div id="preamble">
<div class="sectionbody">
<div id="ht-loader" class="paragraph">
<p>This content cannot be displayed without JavaScript.<br>
Please enable JavaScript and reload the page.</p>
</div>
<div class="paragraph">
<p><a href="" class="bare"></a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_docs62"><a class="anchor" href="#_docs62"></a><span class="ht-logo-label">DOCS62</span> <span class="image"><img src="../../_images/DOCS62.png" alt="image"></span></h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="Modules.html" class="bare">Modules.html</a></p>
</div>
<div class="sect2">
<h3 id="_magnolia_6_2_documentation"><a class="anchor" href="#_magnolia_6_2_documentation"></a>Magnolia 6.2 documentation</h3>
<div id="ht-sidebar-dragbar" class="paragraph">
<p><span class="drag-handle-1"> [.drag-handle-2]</span> [.drag-handle-3]##</p>
</div>
<div id="ht-breadcrumb" class="ulist">
<ul>
<li>
<p><a href="Modules.html">Magnolia 6.2 documentation</a></p>
</li>
<li>
<p><a href="">&#8230;&#8203;</a></p>
</li>
<li>
<p><a href="List_of_modules.html">List of modules</a></p>
</li>
<li>
<p><a href="Workflow_module.html">Workflow module</a></p>
</li>
<li>
<p><a href="jBPM_integration.html">jBPM integration</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="src-196597508"><a class="anchor" href="#src-196597508"></a>JCR persistence</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="src-196597508_JCRpersistence-jBPMpersistence"><a class="anchor" href="#src-196597508_JCRpersistence-jBPMpersistence"></a>jBPM persistence</h2>
<div class="sectionbody">
<div class="paragraph">
<p>jBPM implements a persistence layer based on JPA and Hibernate.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>jBPM allows the persistent storage of certain information. This chapter
describes these different types of persistence, and how to configure
them. An example of the information stored is the process runtime state.
Storing the process runtime state is necessary in order to be able to
continue execution of a process instance at any point, if something goes
wrong.&#8201;&#8212;&#8201;<a href="http://docs.jboss.org/jbpm/v6.0.1/userguide/jBPMPersistence.html">jBPM:
Persistence and Transactions</a></p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>In short the persistence allows shutting down the system and restoring
the state of all running processes upon restart.</p>
</div>
<div class="paragraph">
<p>In order to not have to set up a separate storage mechanism in Magnolia
for the jBPM engine, Magnolia provides its own JCR persistence layer for
jBPM.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="jcr-persistence"><a class="anchor" href="#jcr-persistence"></a>JCR persistence</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Magnolia stores all runtime data from the the jBPM engine in the
<code>workflow</code> workspace. By default workflow is only enabled on the author
instance.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../../_images/images/download/attachments/196597508/workflow_workspace.png" alt="images/download/attachments/196597508/workflow_workspace.png"></span></p>
</div>
<div class="paragraph">
<p>jBPM stores most of the data used for its execution as binary data using
marshalling mechanisms. This makes the underlaying scheme rather simple.</p>
</div>
<div class="sect2">
<h3 id="src-196597508_JCRpersistence-Session"><a class="anchor" href="#src-196597508_JCRpersistence-Session"></a>Session</h3>
<div class="paragraph">
<p>As we are using the
<a href="http://docs.jboss.org/jbpm/v6.0.1/userguide/jBPMCoreEngine.html#d0e1975">singleton
strategy</a> for our runtime engine we are only dealing with one session.
This session is stored under the <code>sessions</code> node with <code>0</code> as static
identifier and is never removed. All data is marshalled into the binary
property <code>bytes</code>.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../../_images/images/download/attachments/196597508/Screen_Shot_2014-03-21_at_10.50.25.png" alt="images/download/attachments/196597508/Screen_Shot_2014-03-21_at_10.50.25.png"></span></p>
</div>
<div class="paragraph">
<p>[.admonition-icon .confluence-information-macro-icon]##</p>
</div>
<div class="paragraph">
<p>The session ID is not using the key generator Magnolia uses for storing
processes and workItems. One reason is that by using the singleton
strategy this is not necessary at the moment at least. Another reason
ist that the interfaces and implementation classes used inside the jBPM
persistence package is restricted to use integers as IDs, compared to
processInstances and workItems using a long.</p>
</div>
<div class="sect3">
<h4 id="src-196597508_JCRpersistence-Marshalling"><a class="anchor" href="#src-196597508_JCRpersistence-Marshalling"></a>Marshalling</h4>
<div class="paragraph">
<p>The marshalling is done inside the SessionInfo&#8217;s update method, which is
an object used and created by the CommandService.</p>
</div>
<div class="paragraph">
<p>SimpleSessionCommandService</p>
</div>
<div class="paragraph">
<p><code>protected<code> </code>void`</code> initNewKnowledgeSession(KieBase kbase, KieSessionConfiguration conf) {`</p>
</div>
<div class="paragraph">
<p>`        <code>this</code>.sessionInfo = <code>new</code> SessionInfo();`</p>
</div>
<div class="paragraph">
<p>`      &#8230;&#8203;`</p>
</div>
<div class="paragraph">
<p>`        <code>this</code>.marshallingHelper = <code>new</code> SessionMarshallingHelper( <code>this</code>.ksession, conf );`</p>
</div>
<div class="paragraph">
<p>`        <code>this</code>.sessionInfo.setJPASessionMashallingHelper( <code>this</code>.marshallingHelper );`</p>
</div>
<div class="paragraph">
<p>`      &#8230;&#8203;`</p>
</div>
<div class="paragraph">
<p>`        <code>this</code>.commandService = <code>new</code> TransactionInterceptor(kContext);`</p>
</div>
<div class="paragraph">
<p><code>}</code></p>
</div>
<div class="paragraph">
<p>SessionInfo</p>
</div>
<div class="paragraph">
<p>`    <code>public</code> <code>void</code> update() {`</p>
</div>
<div class="paragraph">
<p>`        <code>this</code>.rulesByteArray  = <code>this</code>.helper.getSnapshot();`</p>
</div>
<div class="paragraph">
<p>`    }`</p>
</div>
</div>
<div class="sect3">
<h4 id="src-196597508_JCRpersistence-SessionStore"><a class="anchor" href="#src-196597508_JCRpersistence-SessionStore"></a>SessionStore</h4>
<div class="paragraph">
<p>Persisting the SessionInfo is handled by the <code>JcrSessionStore</code>
implementation in <code>SystemContextSessionStore</code> where all operations are
performed in Magnolia&#8217;s <code>SystemContext</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="src-196597508_JCRpersistence-ProcessInstance"><a class="anchor" href="#src-196597508_JCRpersistence-ProcessInstance"></a>ProcessInstance</h3>
<div class="paragraph">
<p>Processes are stored under the <code>processInstances</code> node inside the
<code>workflow</code> workspace. As this data is used during the actual execution
of processes, the data is removed when the process terminates.
Magnolia&#8217;s current implementation does not support logging completed
processes for further auditing. For more information how this could be
implemented, see the documentation of
<a href="http://docs.jboss.org/jbpm/v6.0.1/userguide/jBPMPersistence.html#d0e4482">jBPM
Audit data model</a>.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../../_images/images/download/attachments/196597508/Screen_Shot_2014-03-21_at_12.29.16.png" alt="images/download/attachments/196597508/Screen_Shot_2014-03-21_at_12.29.16.png"></span></p>
</div>
<div class="sect3">
<h4 id="src-196597508_JCRpersistence-Keygenerator"><a class="anchor" href="#src-196597508_JCRpersistence-Keygenerator"></a>Key generator</h4>
<div class="paragraph">
<p>For creating the IDs for process instances we use the
<code>ProcessInstanceIdGenerator</code> which creates a Long from the current
system time. The processes are further stored hierarchical based on
year, month of year and day of month.</p>
</div>
</div>
<div class="sect3">
<h4 id="src-196597508_JCRpersistence-Marshalling.1"><a class="anchor" href="#src-196597508_JCRpersistence-Marshalling.1"></a>Marshalling</h4>
<div class="paragraph">
<p>Similar to the sessions, the processes use a marshalling mechanism and
most of the runtime data is stored as a binary under the bytes property.
The marshalling is performed inside ProcessInstanceInfo&#8217;s update method.
The info object is created by <code>JcrProcessInstanceManager</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="src-196597508_JCRpersistence-ProcessInstanceStore"><a class="anchor" href="#src-196597508_JCRpersistence-ProcessInstanceStore"></a>ProcessInstanceStore</h4>
<div class="paragraph">
<p>Persisting the ProcessInstanceInfo is handled by the <code>JcrProcessStore</code>
implementation in <code>SystemContextProcessStore</code> where all operations are
performed in Magnolia&#8217;s <code>SystemContext</code>. Because we do not need the
<code>correlation key</code> used for mapping sessions to processInstances due to
the <code>singleton strategy</code>, those methods are currently not implemented.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="src-196597508_JCRpersistence-Workitem"><a class="anchor" href="#src-196597508_JCRpersistence-Workitem"></a>Workitem</h3>
<div class="paragraph">
<p><span class="image"><img src="../../_images/images/download/attachments/196597508/Screen_Shot_2014-03-21_at_13.36.13.png" alt="images/download/attachments/196597508/Screen_Shot_2014-03-21_at_13.36.13.png"></span></p>
</div>
<div class="sect3">
<h4 id="src-196597508_JCRpersistence-Keygenerator.1"><a class="anchor" href="#src-196597508_JCRpersistence-Keygenerator.1"></a>Key generator</h4>
<div class="paragraph">
<p>Workitems are using the same hierarchical structure and keys as the
processInstances. The key generator used is implemented in
<code>WorkItemIdGenerator</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="src-196597508_JCRpersistence-Marshalling.2"><a class="anchor" href="#src-196597508_JCRpersistence-Marshalling.2"></a>Marshalling</h4>
<div class="paragraph">
<p>The marshalling of work items happens in the update method of the
<code>WorkItemInfo</code> object and the binary data is stored under the <code>bytes</code>
property.</p>
</div>
</div>
<div class="sect3">
<h4 id="src-196597508_JCRpersistence-WorkItemStore"><a class="anchor" href="#src-196597508_JCRpersistence-WorkItemStore"></a>WorkItemStore</h4>
<div class="paragraph">
<p>Persisting the WorkItemInfo is handled by the <code>JcrWorkItemStore</code>
implementation in <code>SystemContextWorkitemStore</code> where all operations are
performed in Magnolia&#8217;s <code>SystemContext</code>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="src-196597508_JCRpersistence-Safepoints"><a class="anchor" href="#src-196597508_JCRpersistence-Safepoints"></a>Safe points</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Contrary to the simple storage scheme finding the right spots to persist
the current state of a process is a bit more tricky. These spots are
called
<a href="http://docs.jboss.org/jbpm/v6.0.1/userguide/jBPMPersistence.html#d0e4042">safe
points</a>:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>The state of a process instance is stored at so-called "safe points"
during the execution of the process engine. Whenever a process instance
is executing (for example when it started or continuing from a previous
wait state, the engine executes the process instance until no more
actions can be performed (meaning that the process instance either has
completed (or was aborted), or that it has reached a wait state in all
of its parallel paths). At that point, the engine has reached the next
safe state, and the state of the process instance (and all other process
instances that might have been affected) is stored persistently. –
<a href="http://docs.jboss.org/jbpm/v5.3/userguide/ch.core-persistence.html#d0e3587">jBPM:
Safe Points</a></p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>These safe points are reached by different classes. Some of of the logic
is taken care of by the <code>ProcessInstanceManager</code> and <code>WorkItemManager</code>
where the state is persisted when the execution starts or is completed.
As this is not sufficient for keeping the persisted state updated at all
times we hook into the internal execution of a process with the
<code>CommandService</code>.</p>
</div>
<div class="sect2">
<h3 id="src-196597508_JCRpersistence-CommandService"><a class="anchor" href="#src-196597508_JCRpersistence-CommandService"></a>CommandService</h3>
<div class="paragraph">
<p>To persist the processes at safe points, Magnolia uses a CommandService
which allows intercepting internally used Commands.</p>
</div>
<div class="paragraph">
<p>When loading or creating a <code>KieSession</code> by the <code>JcrSessionFactory</code> it
delegates the creation to <code>JcrKieStoreServices</code> which in turn creates a
<code>CommandBasedStatefulKnowledgeSession</code>, an implementation of the
<code>KieSession</code> creating Commands for each step of the process.</p>
</div>
<div class="paragraph">
<p>As an example this is how the <code>CommandBasedStatefulKnowledgeSession</code>
starts a process by creating a <code>StartProcessCommand</code> containing the
processId and the parameters. You also see how the actual execution of
the command is delegated to the <code>commandService</code>.</p>
</div>
<div class="paragraph">
<p><code>&#8230;&#8203;</code></p>
</div>
<div class="paragraph">
<p>`    <code>public</code> ProcessInstance startProcess(String processId, Map&lt;String, Object&gt; parameters) {`</p>
</div>
<div class="paragraph">
<p>`        StartProcessCommand command = <code>new</code> StartProcessCommand();`</p>
</div>
<div class="paragraph">
<p>`        command.setProcessId( processId );`</p>
</div>
<div class="paragraph">
<p>`        command.setParameters( parameters );`</p>
</div>
<div class="paragraph">
<p>`        <code>return</code> commandService.execute( command );`</p>
</div>
<div class="paragraph">
<p>`    }`</p>
</div>
<div class="paragraph">
<p><code>&#8230;&#8203;</code></p>
</div>
<div class="paragraph">
<p>When not using the <code>CommandBasedStatefulKnowledgeSession</code> this would
create a <code>ProcessInstance</code> and directly start it.</p>
</div>
<div class="sect3">
<h4 id="src-196597508_JCRpersistence-Interceptors"><a class="anchor" href="#src-196597508_JCRpersistence-Interceptors"></a>Interceptors</h4>
<div class="paragraph">
<p>The interceptors used for persisting the state are registered by the
<code>JcrSessionFactory</code> to the <code>commandService</code>.</p>
</div>
<div class="paragraph">
<p>The concept behind these interceptors is rather simple. They act as
CommandExecutors for commands and allow adding custom logic before and
after executing the command. As an example let&#8217;s take a look at the
<code>JcrPersistProcessInterceptor</code> which takes care of persisting
ProcessInstances.</p>
</div>
<div class="paragraph">
<p>JcrPersistProcessInterceptor</p>
</div>
<div class="paragraph">
<p>`    `</p>
</div>
<div class="paragraph">
<p>`    <code>public</code> JcrPersistProcessInterceptor(SimpleSessionCommandService interceptedService) {`</p>
</div>
<div class="paragraph">
<p>`        <code>this</code>.interceptedService = interceptedService;`</p>
</div>
<div class="paragraph">
<p>`    }`</p>
</div>
<div class="paragraph">
<p>` `</p>
</div>
<div class="paragraph">
<p>`  <code>`@Override</code></p>
</div>
<div class="paragraph">
<p>`    <code>public</code> &lt;T&gt; T execute(Command&lt;T&gt; command) {`</p>
</div>
<div class="paragraph">
<p>`        T result = <code>null</code>;`</p>
</div>
<div class="paragraph">
<p>`        <code>try</code> {`</p>
</div>
<div class="paragraph">
<p>`            result = executeNext(command);`</p>
</div>
<div class="paragraph">
<p>`      }`</p>
</div>
<div class="paragraph">
<p>`      &#8230;&#8203;`</p>
</div>
<div class="paragraph">
<p>`        <code>if</code> (isValidCommand(command)) {`</p>
</div>
<div class="paragraph">
<p>`            executeNext(<code>new</code> PersistProcessCommand(jpm, ksession));`</p>
</div>
<div class="paragraph">
<p>`        }`</p>
</div>
<div class="paragraph">
<p>`      &#8230;&#8203;`</p>
</div>
<div class="paragraph">
<p>`  }`</p>
</div>
<div class="paragraph">
<p>` `</p>
</div>
<div class="paragraph">
<p>`    <code>protected</code> <code>boolean</code> isValidCommand(Command&lt;?&gt; command) {`</p>
</div>
<div class="paragraph">
<p>`        <code>return</code> (command <code>instanceof</code> StartProcessCommand) ||`</p>
</div>
<div class="paragraph">
<p>`                (command <code>instanceof</code> CreateProcessInstanceCommand) ||`</p>
</div>
<div class="paragraph">
<p>`                &#8230;&#8203;`</p>
</div>
<div class="paragraph">
<p>`                (command <code>instanceof</code> FireAllRulesCommand);`</p>
</div>
<div class="paragraph">
<p>`    }`</p>
</div>
<div class="paragraph">
<p>Note how the interceptor creates and executes a <code>PersistProcessCommand</code>
in case the Command met the criteria of <code>isValidCommand(command)</code>.
Persisting the ProcessInstance is then taken care of by the
PersistProcessCommand.</p>
</div>
<div class="paragraph">
<p>PersistProcessCommand</p>
</div>
<div class="paragraph">
<p>`    <code>public</code> PersistProcessCommand(Object jpm, KieSession ksession) {`</p>
</div>
<div class="paragraph">
<p>`        <code>this</code>.persistenceContext = ((ProcessPersistenceContextManager) jpm).getProcessPersistenceContext();`</p>
</div>
<div class="paragraph">
<p>`        <code>this</code>.ksession = ksession;`</p>
</div>
<div class="paragraph">
<p>`    }`</p>
</div>
<div class="paragraph">
<p>`    <code>`@Override</code></p>
</div>
<div class="paragraph">
<p>`    <code>public</code> Void execute(Context context) {`</p>
</div>
<div class="paragraph">
<p>`      &#8230;&#8203;`</p>
</div>
<div class="paragraph">
<p>`        ProcessInstanceInfo info = <code>new</code> ProcessInstanceInfo(instance, ksession.getEnvironment());`</p>
</div>
<div class="paragraph">
<p>`        info.setId(instance.getId());`</p>
</div>
<div class="paragraph">
<p>`        info.update();`</p>
</div>
<div class="paragraph">
<p>`        persistenceContext.persist(info);`</p>
</div>
<div class="paragraph">
<p>`        &#8230;&#8203;`</p>
</div>
<div class="paragraph">
<p>`     } `</p>
</div>
<div class="paragraph">
<p>A similar interceptor is used for persisting the session state.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="src-196597508_JCRpersistence-JCRpersistencediagram"><a class="anchor" href="#src-196597508_JCRpersistence-JCRpersistencediagram"></a>JCR persistence diagram</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This diagram shows the most important classes used for persisting
sessions, workitems and processes to JCR.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../../_images/images/download/attachments/196597508/UML_peristence.png" alt="images/download/attachments/196597508/UML_peristence.png"></span></p>
</div>
<div class="paragraph">
<p>jBPM runtime</p>
</div>
<div class="paragraph">
<p>Light modules</p>
</div>
<div class="paragraph">
<p><a href="#" class="bare">#</a></p>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.magnolia-cms.com" class="icon">
            <img src="../../../_/img/magnolia-medium.png" alt="Magnolia">
          </a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://documentation.magnolia-cms.com" target="_blank" rel="noopener">Full Docs Set</a></li>
          <li><a href="https://wiki.magnolia-cms.com/" target="_blank" rel="noopener">Community Wiki</a></li>
          <li><a href="https://support.magnolia-cms.com" target="_blank" rel="noopener">Support</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://marketplace.magnolia-cms.com/" target="_blank" rel="noopener">Extend Magnolia</a></li>
          <li><a href="https://magnolia-cms.com/blog" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.magnolia-cms.com/training" target="_blank" >Training</a></li>
        </ul>
      </div>
      <div class="col">
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <a href="https://www.facebook.com/Magnolia" target="_blank" class="icon">
              <svg width="50px" height="50px" viewBox="26.363 116.363 560.215 560.215"><path d="m586.58 209.58c0-48.96-44.252-93.212-93.212-93.212h-373.79c-48.96 0-93.212 44.252-93.212 93.212v373.79c0 48.96 44.252 93.212 93.212 93.212h186.42v-211.85h-68.732v-93.212h68.732v-36.72c0-63.083 47.077-119.58 105.45-119.58h75.323v93.212h-75.323c-8.474 0-17.889 10.357-17.889 25.422v37.662h93.212v93.212h-93.212v211.85h99.803c48.96 0 93.212-44.252 93.212-93.212v-373.79z"/></svg>
            </a>
          </li>
          <li>
            <a href="https://twitter.com/magnolia_cms" target="_blank" class="icon">
              <svg width="50px" height="50px" viewBox="32.012 176.622 542.326 437.815"><path d="m574.34 227.46c-19.772 8.474-41.428 15.065-64.025 17.889 22.597-14.123 40.486-35.778 48.96-61.2-21.655 13.182-45.194 21.655-70.615 27.305-20.714-21.655-48.96-34.837-80.972-34.837-61.2 0-111.1 49.902-111.1 111.1 0 8.474 0.942 16.948 2.825 25.422-92.271-5.649-174.18-49.902-229.74-117.69-9.415 16.006-15.065 35.778-15.065 55.551 0 38.603 19.772 72.498 49.902 92.271-17.889-0.942-35.778-5.649-50.843-14.123v0.942c0 53.668 38.603 98.862 89.446 109.22-9.415 2.825-18.831 3.766-29.188 3.766-7.532 0-14.123-0.942-20.714-1.883 14.123 44.252 55.551 76.265 103.57 77.206-37.662 30.129-85.68 48.018-138.41 48.018-9.415 0-17.889-0.941-26.363-1.883 48.96 32.012 107.34 49.902 170.42 49.902 204.31 0 316.36-169.48 316.36-316.36v-14.123c21.656-14.125 40.487-33.897 55.551-56.494z"/></svg>
            </a>
          </li>
          <li>
            <a href="https://www.linkedin.com/company/magnolia-cms" target="_blank" class="icon">
              <svg width="50px" height="50px" viewBox="31.071 119.188 539.537 540.443"><path d="m531.97 119.19h-461.35c-21.655 0-39.545 16.948-39.545 38.603v463.24c0 21.655 17.889 38.603 39.545 38.603h460.41c21.655 0 39.545-16.948 39.545-38.603v-463.24c0.942-21.656-16.947-38.603-38.603-38.603zm-337.07 451.94h-81.914v-243.86h81.914v243.86zm-40.486-276.81c-28.246 0-46.135-18.831-46.135-42.369s17.889-42.369 46.135-42.369 45.194 17.889 45.194 42.369c0.942 23.538-16.948 42.369-45.194 42.369zm335.19 276.81h-81.914v-129.93c0-32.954-12.24-55.551-41.428-55.551-22.597 0-35.778 15.065-41.428 30.129-1.883 5.649-2.825 12.24-2.825 19.772v136.52h-81.914s0.942-221.26 0-243.86h81.914v34.837c11.298-16.948 30.129-40.486 73.44-40.486 53.668 0 94.154 34.837 94.154 110.16l1e-3 138.41zm-168.54-208.08s0.941-0.941 0 0z"/></svg>
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <span>2020 Magnolia International Ltd. All rights reserved.</span>
      <a href="https://www.magnolia-cms.com/legal/privacy.html">Privacy Policy</a>
    </div>
  </div>
</footer>

<script src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
